{% include './staffHeader.html' %}
<style>
.tableClass {
  margin: 3% auto;
  padding: 2%;
  border-radius: 20px;
  box-shadow: 1px 3px 18px 2px rgba(0,0,0,0.15);
  background-color: #fff;
  max-width: 95%;
}

.table th, .table td {
  vertical-align: middle;
  text-align: center;
}

@media (max-width: 768px) {
  .tableClass {
    margin: 2%;
    padding: 1%;
  }

  h3.fw-bold {
    font-size: 1.2rem;
  }

  .table th, .table td {
    font-size: 0.8rem;
    padding: 0.5rem;
  }

  #searchInput {
    font-size: 0.85rem;
  }
}
</style>

<div class="mt-4 tableClass">
  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h3 class="fw-bold text-primary mb-2 mb-md-0">üè® Stay Management</h3>
    <a href="/createStayPage/" class="text-decoration-none">
      <button class="btn btn-primary btn-sm px-3">
        ‚ûï Create Stay
      </button>
    </a>
  </div>

  <!-- Search -->
  <div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="üîç Search guest or room...">
  </div>

  <!-- Responsive Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>Stay ID</th>
          <th>Guest Name</th>
          <th>Room Code</th>
          <th>Check-In</th>
          <th>Check-Out</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="stayTable">
        {% for stay in stays %}
        <tr>
          <td>{{ stay.stayID }}</td>
          <td>{{ stay.guestID.guestName }}</td>
          <td>{{ stay.roomID.building }}-{{ stay.roomID.roomCode }}</td>
          <td>{{ stay.check_in }}</td>
          <td>{{ stay.check_out }}</td>
          <td>
            {% if stay.check_out > today %}
              <span class="badge bg-danger">Time Out</span>
            {% elif stay.status == "Paid" %}
              <span class="badge bg-success">Paid</span>
            {% else %}
              <span class="badge bg-warning text-dark">Pending</span>
            {% endif %}
          </td>
          {% if stay.status != "Paid" %}
          <td>
            <button class="btn btn-success btn-sm" onclick="openEndStayModal('{{ stay.stayID }}')">
              End Stay
            </button>
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-muted py-4">
            <i class="bi bi-inbox fs-3 d-block mb-2"></i>
            No stays found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- End Stay Modal -->
<form action="/endStay/" method="post">
  {% csrf_token %}
  <div class="modal fade" id="endStayModal" tabindex="-1" aria-labelledby="endStayModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content rounded-4 shadow">
        <div class="modal-header bg-primary text-white rounded-top-4">
          <h5 class="modal-title fw-semibold" id="endStayModalLabel">üßæ End Stay - Details</h5>
          <input type="hidden" name="stayID" id="stayID">
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="card border-0 shadow-sm rounded-4 mb-3">
            <div class="card-header fw-bold bg-light">
              <i class="bi bi-door-closed me-2 text-primary"></i> Room Information
            </div>
            <div class="card-body" id="roomData">
              <p class="text-center text-muted">Loading Room Data...</p>
            </div>
          </div>

          <h6 class="fw-bold mb-2">Services Used:</h6>
          <ul id="serviceList" class="list-group mb-3">
            <li class="list-group-item text-center text-muted">Loading services...</li>
          </ul>

          <h6 class="fw-bold mb-2">Orders Made:</h6>
          <ul id="orderList" class="list-group mb-3">
            <li class="list-group-item text-center text-muted">Loading orders...</li>
          </ul>

          <div class="card mt-3 border-0 shadow-sm rounded-4 text-center">
            <div class="card-body">
              <h5 class="fw-bold text-success mb-2">
                <i class="bi bi-cash-coin me-2"></i> Total Charges
                <input type="hidden" name="totalAmount" id="totalCharge">
              </h5>
              <h2 id="totalAmount" class="fw-bolder text-primary mb-0"></h2>
              <small class="text-muted fst-italic">Includes room, services, and orders</small>
            </div>
          </div>

          <div class="card mt-3 border-0 shadow-sm rounded-4">
            <div class="card-body">
              <h6 class="fw-bold mb-3">
                <i class="bi bi-wallet2 me-2 text-primary"></i> Payment Type
              </h6>
              <select id="paymentType" name="paymentType" class="form-select form-select-lg border-primary shadow-sm">
                <option value="" selected disabled>-- Select Payment Type --</option>
                <option value="Cash">üíµ Cash</option>
                <option value="Credit Card">üí≥ Credit Card</option>
                <option value="Electronic Payment">üì± Electronic Payment</option>
                <option value="Others">‚ãØ Others</option>
              </select>

              <div id="otherPaymentDiv" class="mt-3 d-none">
                <input type="text" id="otherPaymentText" class="form-control" placeholder="Specify other payment type...">
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success">‚úÖ Confirm End Stay</button>
        </div>
      </div>
    </div>
  </div>
</form>

<script>
// üîç Search Function
document.getElementById('searchInput').addEventListener('keyup', (event) => {
  const filter = event.target.value.toLowerCase();
  document.querySelectorAll("#stayTable tr").forEach(row => {
    row.style.display = row.textContent.toLowerCase().includes(filter) ? "" : "none";
  });
});

// ü™ü Open End Stay Modal
async function openEndStayModal(stayID) {
  document.getElementById('stayID').value = stayID;
  const modal = new bootstrap.Modal(document.getElementById('endStayModal'));
  modal.show();

  const serviceList = document.getElementById("serviceList");
  const orderList = document.getElementById("orderList");

  serviceList.innerHTML = `<li class="list-group-item text-center text-muted">Loading services...</li>`;
  orderList.innerHTML = `<li class="list-group-item text-center text-muted">Loading orders...</li>`;

  try {
    const [serviceRes, orderRes, roomRes] = await Promise.all([
      fetch(`/api/stay/${stayID}/services`),
      fetch(`/api/stay/${stayID}/orders`),
      fetch(`/api/totalAmount/${stayID}`)
    ]);

    const services = await serviceRes.json();
    const orders = await orderRes.json();
    const roomData = await roomRes.json();

    // Room info
    if (roomData) {
      document.getElementById('totalAmount').innerText = roomData.totalAmount;
      document.getElementById('totalCharge').value = roomData.totalAmount;
      document.getElementById('roomData').innerHTML = `
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between"><span>Room Code</span><span>${roomData.roomCode}</span></li>
          <li class="list-group-item d-flex justify-content-between"><span>Stay Duration</span><span>${roomData.duration} days</span></li>
          <li class="list-group-item d-flex justify-content-between"><span>Total Amount</span><span>${roomData.roomAmount} Ks</span></li>
        </ul>`;
    }

    // Services
    serviceList.innerHTML = services.length
      ? services.map(s => `<li class="list-group-item d-flex justify-content-between"><span>${s.type}</span><span class="badge bg-primary">${s.status}</span></li>`).join("")
      : `<li class="list-group-item text-center text-muted">No services found.</li>`;

    // Orders
    orderList.innerHTML = orders.length
      ? orders.map(o => `
        <li class="list-group-item">
          <div class="d-flex justify-content-between align-items-center">
            <span>#${o.orderID}</span><span>${o.amount} Ks</span>
          </div>
          <ul class="mt-2">${o.menuItems.map(i => `<li>${i.name} √ó ${i.qty} - ${i.price} Ks</li>`).join('')}</ul>
        </li>`).join("")
      : `<li class="list-group-item text-center text-muted">No orders found.</li>`;
  } catch (error) {
    console.error("Error loading stay details:", error);
  }
}
</script>
